

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>decogo.model.model_decomposer &mdash; Decogo 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Decogo
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/example.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/modules.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/classes.html">Class inheritance diagram</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Decogo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>decogo.model.model_decomposer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for decogo.model.model_decomposer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Performs automatic reformulation of the Pyomo model&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">pyomo.core.base.constraint</span> <span class="kn">import</span> <span class="n">Constraint</span><span class="p">,</span> <span class="n">IndexedConstraint</span><span class="p">,</span> \
    <span class="n">ScalarConstraint</span>
<span class="kn">from</span> <span class="nn">pyomo.core.base.var</span> <span class="kn">import</span> <span class="n">Var</span><span class="p">,</span> <span class="n">IndexedVar</span><span class="p">,</span> <span class="n">ScalarVar</span>
<span class="kn">from</span> <span class="nn">pyomo.core.expr.numeric_expr</span> <span class="kn">import</span> <span class="n">ProductExpression</span><span class="p">,</span> <span class="n">SumExpression</span><span class="p">,</span> \
    <span class="n">UnaryFunctionExpression</span><span class="p">,</span> <span class="n">PowExpression</span><span class="p">,</span> \
    <span class="n">DivisionExpression</span><span class="p">,</span> <span class="n">NegationExpression</span><span class="p">,</span> <span class="n">AbsExpression</span><span class="p">,</span> \
    <span class="n">MonomialTermExpression</span>
<span class="kn">from</span> <span class="nn">pyomo.core.expr.visitor</span> <span class="kn">import</span> <span class="n">identify_variables</span><span class="p">,</span> <span class="n">replace_expressions</span>
<span class="kn">from</span> <span class="nn">pyomo.environ</span> <span class="kn">import</span> <span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">Block</span><span class="p">,</span> <span class="n">Objective</span><span class="p">,</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">maximize</span><span class="p">,</span> \
    <span class="n">SolverFactory</span><span class="p">,</span> <span class="n">Reals</span><span class="p">,</span> <span class="n">Set</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;decogo&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="PyomoModelDecomposer"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer">[docs]</a><span class="k">class</span> <span class="nc">PyomoModelDecomposer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class performs the decomposition of the Pyomo model based on the</span>
<span class="sd">    defined blocks. If for definition of Pyomo model keyword Block was used</span>
<span class="sd">    explicitly, then the reformulation is not performed.</span>

<span class="sd">    :param model: Input pyomo model</span>
<span class="sd">    :type model: ConcreteModel</span>
<span class="sd">    :param settings: Settings</span>
<span class="sd">    :type settings: Settings</span>
<span class="sd">    :param blocks: List of original names (strings) of variables collected \</span>
<span class="sd">    blockwise</span>
<span class="sd">    :type blocks: list</span>
<span class="sd">    :param original_obj_sense: Indicates the sense of the objective \</span>
<span class="sd">    (maximization or minimization)</span>
<span class="sd">    :type original_obj_sense: int</span>
<span class="sd">    :param number_defined_blocks: Number of defined blocks of the original \</span>
<span class="sd">    model, defaults to 1</span>
<span class="sd">    :type number_defined_blocks: int</span>
<span class="sd">    :param nconstraints: Overall number of the constraints of the input model \</span>
<span class="sd">    :type nconstraints: int</span>
<span class="sd">    :param nvars: Number of variables of the input model</span>
<span class="sd">    :type nvars: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PyomoModelDecomposer.__init__"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor method&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># only names of the variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_obj_sense</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">sense</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_defined_blocks</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># by default is one block</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nconstraints</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer.decompose"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer.decompose">[docs]</a>    <span class="k">def</span> <span class="nf">decompose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The function which calls other functions for block detection and</span>
<span class="sd">        reformulation. Reformulates Pyomo model as block-separable with</span>
<span class="sd">        linear objective, with nonlinear local constraints and linear global</span>
<span class="sd">        constraints.</span>

<span class="sd">        :return: Reformulated model, variables (string names) collected \</span>
<span class="sd">        blockwise, original objective sense</span>
<span class="sd">        :rtype: (ConcreteModel, list, int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_number_of_defined_blocks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_initial_statistics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessing</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_blocks</span><span class="p">()</span>

        <span class="c1"># no reformulation if the blocks are given</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_defined_blocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reformulate</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_obj_sense</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._find_connected_components"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._find_connected_components">[docs]</a>    <span class="k">def</span> <span class="nf">_find_connected_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct the graph which describes the sparsity pattern of the</span>
<span class="sd">        Hessian of the Lagrangian. Two nodes are connected if the</span>
<span class="sd">        corresponding variables are contained in the same nonlinear expression.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># construct graph for all variables</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span><span class="n">Var</span><span class="p">):</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>

        <span class="c1"># store nonlinear variables in order later to create one common block</span>
        <span class="c1"># for linear variables</span>
        <span class="n">nonlinear_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">object_name</span><span class="p">,</span> <span class="nb">object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span>
                <span class="p">[</span><span class="n">Objective</span><span class="p">,</span> <span class="n">Constraint</span><span class="p">],</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">Objective</span><span class="p">):</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">expr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_edges_to_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">nonlinear_vars</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">IndexedConstraint</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">object</span><span class="p">:</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="nb">object</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_edges_to_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">nonlinear_vars</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">body</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_edges_to_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">nonlinear_vars</span><span class="p">)</span>

        <span class="c1"># block that contains only linear variables, i.e. variables that are</span>
        <span class="c1"># contained only linear expressions</span>
        <span class="n">linear_block</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">nonlinear_vars</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">component</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># here component should consist of one variable element</span>
                <span class="n">linear_block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linear_block</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linear_block</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._add_edges_to_graph"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._add_edges_to_graph">[docs]</a>    <span class="k">def</span> <span class="nf">_add_edges_to_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">nonlinear_vars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recursive function for construction of the sparsity graph.</span>
<span class="sd">        The two nodes are connected if respective variables contained in the</span>
<span class="sd">        same nonlinear expression.</span>

<span class="sd">        :param g: Graph</span>
<span class="sd">        :type g: Graph</span>
<span class="sd">        :param expr: Expression which is currently processed</span>
<span class="sd">        :type expr: Expression</span>
<span class="sd">        :param nonlinear_vars: List of nonlinear variables</span>
<span class="sd">        :type nonlinear_vars: set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">SumExpression</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_edges_to_graph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">nonlinear_vars</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">NegationExpression</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_edges_to_graph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">nonlinear_vars</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">MonomialTermExpression</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">DivisionExpression</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">PowExpression</span> <span class="ow">or</span> \
                <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">UnaryFunctionExpression</span><span class="p">:</span>
            <span class="n">vars_objects</span> <span class="o">=</span> <span class="n">identify_variables</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="c1"># add edges to graph</span>
            <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">vars_objects</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">var_names</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">nonlinear_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span>  <span class="c1"># store nonlinear variables</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">ProductExpression</span><span class="p">:</span>
            <span class="c1"># product expression consists of tuple of length two</span>
            <span class="c1"># if one element is a number and the other SumExpression, then it</span>
            <span class="c1"># is necessary to go one level further, i.e. into SumExpression</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="nb">any</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">SumExpression</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">SumExpression</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_edges_to_graph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">nonlinear_vars</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vars_objects</span> <span class="o">=</span> <span class="n">identify_variables</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="c1"># add edges to graph</span>
                <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">vars_objects</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">var_names</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">nonlinear_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span>  <span class="c1"># store nonlinear variables</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">AbsExpression</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Dev: abs expressions are not supported yet&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._compute_initial_statistics"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._compute_initial_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_initial_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute initial statistics such as number of variables and</span>
<span class="sd">        constraints</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_defined_blocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nvariables</span><span class="p">()</span>
            <span class="n">nconstraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nconstraints</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nvars</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">var_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_objects</span><span class="p">(</span><span class="n">Var</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">ScalarVar</span><span class="p">:</span>
                    <span class="n">nvars</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">var_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">IndexedVar</span><span class="p">:</span>
                    <span class="n">nvars</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_obj</span><span class="p">)</span>

            <span class="n">nconstraints</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">con_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_objects</span><span class="p">(</span><span class="n">Constraint</span><span class="p">,</span>
                                                        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">con_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">ScalarConstraint</span><span class="p">:</span>
                    <span class="n">nconstraints</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">con_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">IndexedConstraint</span><span class="p">:</span>
                    <span class="n">nconstraints</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">con_obj</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Original model:&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: &lt;50}{1: &lt;30}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Number of variables:&#39;</span><span class="p">,</span> <span class="n">nvars</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{0: &lt;50}{1: &lt;30}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Number of constraints:&#39;</span><span class="p">,</span> <span class="n">nconstraints</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._preprocessing"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._preprocessing">[docs]</a>    <span class="k">def</span> <span class="nf">_preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the following preprocessing steps:</span>

<span class="sd">        * deletes trivial constraints (i.e. :math:`x \\leq a`) and updates the \</span>
<span class="sd">        variables bounds;</span>

<span class="sd">        * checks if objective sense is :math:`\\max`; if so, then \</span>
<span class="sd">        :math:`\\max f(x) = \\min -f(x)`</span>

<span class="sd">        * estimates bounds of unbounded variables, if the respective setting \</span>
<span class="sd">        is set to ``True``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check if no variables have the name &#39;new&#39; in their names</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_defined_blocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># we don&#39;t proceed with it, if we don&#39;t do the reformulation</span>
            <span class="k">for</span> <span class="n">block_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">block_data_objects</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_obj</span> <span class="ow">in</span> \
                        <span class="n">block_obj</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span><span class="n">Var</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;new&#39;</span> <span class="ow">in</span> <span class="n">var_name</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="s1">&#39;Modelling issue: some of the variables contain &#39;</span>
                            <span class="s1">&#39;word &quot;new&quot;, rename these variables&#39;</span><span class="p">)</span>

        <span class="c1"># delete trivial constraints and check if no constraints have the name</span>
        <span class="c1"># &#39;new&#39; in their names</span>
        <span class="k">for</span> <span class="n">block_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">block_data_objects</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">con_name</span><span class="p">,</span> <span class="n">con_obj</span> <span class="ow">in</span> \
                    <span class="n">block_obj</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span><span class="n">Constraint</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_defined_blocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># we don&#39;t check it, since we don&#39;t do reformulation</span>
                    <span class="k">if</span> <span class="s1">&#39;new&#39;</span> <span class="ow">in</span> <span class="n">con_name</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="s1">&#39;Modelling issue: some of the constraints contain \ &#39;</span>
                            <span class="s1">&#39;word &quot;new&quot;, rename these constraints&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con_obj</span><span class="p">,</span> <span class="n">ScalarConstraint</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">Var</span><span class="p">):</span>
                        <span class="n">var_obj</span> <span class="o">=</span> <span class="n">con_obj</span><span class="o">.</span><span class="n">body</span>
                        <span class="k">if</span> <span class="n">con_obj</span><span class="o">.</span><span class="n">equality</span><span class="p">:</span>
                            <span class="n">var_obj</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                            <span class="n">var_obj</span><span class="o">.</span><span class="n">setlb</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                            <span class="n">var_obj</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">con_obj</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">elif</span> <span class="n">con_obj</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">var_obj</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">con_obj</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">var_obj</span><span class="o">.</span><span class="n">setlb</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">block_obj</span><span class="o">.</span><span class="n">del_component</span><span class="p">(</span><span class="n">con_name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con_obj</span><span class="p">,</span> <span class="n">IndexedConstraint</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">con_obj</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">Var</span><span class="p">):</span>
                            <span class="n">var_obj</span> <span class="o">=</span> <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>
                            <span class="k">if</span> <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">equality</span><span class="p">:</span>
                                <span class="n">var_obj</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">var_obj</span><span class="o">.</span><span class="n">setlb</span><span class="p">(</span><span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">var_obj</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">value</span>
                            <span class="k">elif</span> <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">var_obj</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">con_obj</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">var_obj</span><span class="o">.</span><span class="n">setlb</span><span class="p">(</span><span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                            <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Dev: Found constraint object type which was &#39;</span>
                        <span class="s1">&#39;not considered&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">decomp_estimate_var_bounds</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_var_bounds</span><span class="p">()</span>

        <span class="c1"># if objective sense is max, then max obj(x) = min -obj(x)</span>
        <span class="n">obj_name</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span><span class="n">Objective</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">sense</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># if obj sense is max</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">sense</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># set to min</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="o">-</span><span class="n">obj</span><span class="o">.</span><span class="n">expr</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._get_blocks"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._get_blocks">[docs]</a>    <span class="k">def</span> <span class="nf">_get_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identifies the blocks if the there are more defined blocks than one</span>
<span class="sd">        (by default in Pyomo each model has at least one block always),</span>
<span class="sd">        i.e. it is used explicitly keyword Block. The variables which appear</span>
<span class="sd">        only in linear blocks are merged into one block.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">block_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_data_objects</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
            <span class="n">var_names_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_obj</span> <span class="ow">in</span> \
                    <span class="n">block_obj</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span><span class="n">Var</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">var_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">ScalarVar</span><span class="p">:</span>
                    <span class="n">var_names_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">var_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">IndexedVar</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">var_obj</span><span class="p">:</span>
                        <span class="n">var_names_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Dev: Found var object type which was not considered&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_names_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_names_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_copy_constraints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_linear_blocks</span><span class="p">()</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._add_copy_constraints"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._add_copy_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">_add_copy_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds copy constraints in the following case:</span>

<span class="sd">        If some nonlinear constraints have not all variables in the same block,</span>
<span class="sd">        then the common variable for these constraints is identified. For</span>
<span class="sd">        this variable, a new variable and corresponding copy constraint is</span>
<span class="sd">        created.In the expression trees of the nonlinear constraints, a common</span>
<span class="sd">        variable is replaced by the new variable</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># dictionary: variable name -&gt; list of nonlinear constraints names that</span>
        <span class="c1"># contain this variable</span>
        <span class="n">variables_constraints_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">con_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_objects</span><span class="p">(</span><span class="n">Constraint</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">con_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">ScalarConstraint</span><span class="p">:</span>
                <span class="n">degree</span> <span class="o">=</span> <span class="n">con_obj</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">degree</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">degree</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">blocks_vars_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_block_expr</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks_vars_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocks_vars_dict</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">var_to_copy_name</span> <span class="ow">in</span> <span class="n">blocks_vars_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">var_to_copy_name</span> <span class="ow">in</span> <span class="n">variables_constraints_dict</span><span class="p">:</span>
                                    <span class="n">variables_constraints_dict</span><span class="p">[</span>
                                        <span class="n">var_to_copy_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">variables_constraints_dict</span><span class="p">[</span>
                                        <span class="n">var_to_copy_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">con_obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">con_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">IndexedConstraint</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">con_obj</span><span class="p">:</span>
                    <span class="n">degree</span> <span class="o">=</span> <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">degree</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">degree</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">blocks_vars_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_block_expr</span><span class="p">(</span>
                            <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks_vars_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">blocks_vars_dict</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">var_to_copy_name</span> <span class="ow">in</span> <span class="n">blocks_vars_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">var_to_copy_name</span> <span class="ow">in</span> <span class="n">variables_constraints_dict</span><span class="p">:</span>
                                        <span class="n">variables_constraints_dict</span><span class="p">[</span>
                                            <span class="n">var_to_copy_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                            <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">variables_constraints_dict</span><span class="p">[</span>
                                            <span class="n">var_to_copy_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                            <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># find the variable which is contained in the constraints the most</span>
        <span class="c1"># frequently or just that are contained more</span>
        <span class="c1"># than once in different constraints</span>
        <span class="c1"># and enforce to copy the variable not from the subblocks</span>
        <span class="k">for</span> <span class="n">var_to_copy_name</span> <span class="ow">in</span> <span class="n">variables_constraints_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables_constraints_dict</span><span class="p">[</span>
                       <span class="n">var_to_copy_name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;subblocks&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_to_copy_name</span><span class="p">:</span>
                <span class="c1"># this is a hard fix</span>
                <span class="n">var_to_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_component</span><span class="p">(</span><span class="n">var_to_copy_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">con_name</span> <span class="ow">in</span> <span class="n">variables_constraints_dict</span><span class="p">[</span><span class="n">var_to_copy_name</span><span class="p">]:</span>
                    <span class="n">constraint_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_component</span><span class="p">(</span><span class="n">con_name</span><span class="p">)</span>
                    <span class="c1"># get the parent Block object to which are assigned other</span>
                    <span class="c1"># variables, except the one which</span>
                    <span class="c1"># has to be copied</span>
                    <span class="n">constr_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">identify_variables</span><span class="p">(</span><span class="n">constraint_obj</span><span class="o">.</span><span class="n">expr</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">constr_variables</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">var_to_copy</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                            <span class="n">parent_block</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">parent_block</span><span class="p">()</span>
                            <span class="k">break</span>

                    <span class="c1"># new copy variable creation</span>
                    <span class="k">if</span> <span class="n">parent_block</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s1">&#39;copy_variables&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># variables initialization, it looks like one variable</span>
                        <span class="c1"># could be enough, but it considered that it could be</span>
                        <span class="c1"># more. That&#39;s why indexed variable and indexed</span>
                        <span class="c1"># constraint is used</span>
                        <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_variables_index_set</span> <span class="o">=</span> <span class="n">Set</span><span class="p">()</span>
                        <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_variables</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
                            <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_variables_index_set</span><span class="p">)</span>

                        <span class="c1"># constraint initialization</span>
                        <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_constraints_index_set</span> <span class="o">=</span> <span class="n">Set</span><span class="p">()</span>
                        <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_constraints</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span>
                            <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_constraints_index_set</span><span class="p">)</span>
                        <span class="n">add_new_variable</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># we need to check if the current variable have been</span>
                        <span class="c1"># already copied. If yes, then we don&#39;t add new</span>
                        <span class="c1"># variable and new constraint and just use the existing</span>
                        <span class="c1"># variable</span>
                        <span class="n">add_new_variable</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_constraints</span><span class="p">:</span>
                            <span class="n">copy_constraints_vars</span> <span class="o">=</span> <span class="n">identify_variables</span><span class="p">(</span>
                                <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_constraints</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">copy_con_var</span> <span class="ow">in</span> <span class="n">copy_constraints_vars</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">var_to_copy_name</span> <span class="o">==</span> <span class="n">copy_con_var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                                    <span class="n">add_new_variable</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_copy_variable</span> <span class="o">=</span> <span class="n">copy_con_var</span>
                            <span class="k">if</span> <span class="n">add_new_variable</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                <span class="k">break</span>

                    <span class="k">if</span> <span class="n">add_new_variable</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="c1"># add new variable</span>
                        <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_variables_index_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">parent_block</span><span class="o">.</span><span class="n">copy_variables_index_set</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">new_copy_variable</span> <span class="o">=</span> <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_variables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">parent_block</span><span class="o">.</span><span class="n">copy_variables_index_set</span><span class="p">))</span>
                        <span class="n">new_copy_variable</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">var_to_copy</span><span class="o">.</span><span class="n">domain</span>
                        <span class="n">new_copy_variable</span><span class="o">.</span><span class="n">setlb</span><span class="p">(</span><span class="n">var_to_copy</span><span class="o">.</span><span class="n">lb</span><span class="p">)</span>
                        <span class="n">new_copy_variable</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="n">var_to_copy</span><span class="o">.</span><span class="n">ub</span><span class="p">)</span>

                        <span class="c1"># add new variable to the list of blocks</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">parent_block</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_copy_variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">break</span>

                        <span class="c1"># add new copy constraint</span>
                        <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_constraints_index_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">parent_block</span><span class="o">.</span><span class="n">copy_constraints_index_set</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">parent_block</span><span class="o">.</span><span class="n">copy_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">parent_block</span><span class="o">.</span><span class="n">copy_constraints_index_set</span><span class="p">),</span>
                            <span class="n">var_to_copy</span> <span class="o">==</span> <span class="n">new_copy_variable</span><span class="p">)</span>

                    <span class="c1"># expression with new copied variable</span>
                    <span class="n">substitution_map</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">constr_variables</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">var_to_copy_name</span><span class="p">:</span>
                            <span class="n">substitution_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_copy_variable</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">substitution_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">var</span>
                    <span class="n">new_expr</span> <span class="o">=</span> <span class="n">replace_expressions</span><span class="p">(</span><span class="n">constraint_obj</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span>
                                                   <span class="n">substitution_map</span><span class="p">)</span>
                    <span class="n">constraint_obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">new_expr</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._merge_linear_blocks"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._merge_linear_blocks">[docs]</a>    <span class="k">def</span> <span class="nf">_merge_linear_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merges linear blocks into one block, nonlinear are left as they are</span>

<span class="sd">        :raise ValueError: If variable of nonlinear constraint belongs to \</span>
<span class="sd">        different blocks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from the beginning assume that all blocks are linear</span>
        <span class="n">linear_blocks_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">con_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_objects</span><span class="p">(</span><span class="n">Constraint</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">con_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">ScalarConstraint</span><span class="p">:</span>
                <span class="n">degree</span> <span class="o">=</span> <span class="n">con_obj</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">degree</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">degree</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">blocks_vars_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_block_expr</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks_vars_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;Variables of nonlinear constraint seem to belong &#39;</span>
                            <span class="s1">&#39;to different blocks&#39;</span><span class="p">)</span>
                    <span class="c1"># it is expected that dictionary will have one key, and we</span>
                    <span class="c1"># need exactly this key</span>
                    <span class="n">linear_blocks_list</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">blocks_vars_dict</span><span class="p">))]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">con_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">IndexedConstraint</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">con_obj</span><span class="p">:</span>
                    <span class="n">degree</span> <span class="o">=</span> <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">degree</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">degree</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">blocks_vars_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_block_expr</span><span class="p">(</span>
                            <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks_vars_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s1">&#39;Variables of nonlinear constraint seem to &#39;</span>
                                <span class="s1">&#39;belong to different blocks&#39;</span><span class="p">)</span>
                        <span class="c1"># it is expected that dictionary will have one key, and</span>
                        <span class="c1"># we need exactly this key</span>
                        <span class="n">linear_blocks_list</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">blocks_vars_dict</span><span class="p">))]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># merge</span>
        <span class="n">new_blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">linear_block</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">linear_blocks_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">linear_blocks_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">linear_block</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linear_block</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linear_block</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">new_blocks</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._compute_blocks"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._compute_blocks">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls functions depending on the number of defined blocks. If there</span>
<span class="sd">        is only one block detected, then is constructs the sparsity graph</span>
<span class="sd">        depending on the expressions. If there are more than one block, then it</span>
<span class="sd">        simply reads the blocks as defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_defined_blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_blocks</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_find_connected_components</span><span class="p">()</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._determine_block_expr"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._determine_block_expr">[docs]</a>    <span class="k">def</span> <span class="nf">_determine_block_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns the block identifier to the given expression. If the</span>
<span class="sd">        variables in the expression are contained in other blocks, it returns</span>
<span class="sd">        also this blocks</span>

<span class="sd">        :param expr: Expression which needs to be assigned to the blocks</span>
<span class="sd">        :type expr: Expression</span>
<span class="sd">        :return: Block identifier -&gt; variable names dictionary. If length of \</span>
<span class="sd">        dictionary is greater than 1, it means that variables of the \</span>
<span class="sd">        expression are contained in the several blocks</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr_variable_objects</span> <span class="o">=</span> <span class="n">identify_variables</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">expr_variable_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">expr_variable_objects</span><span class="p">)</span>

        <span class="n">block_vars_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">):</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">block</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">expr_variable_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr_variable_names</span><span class="p">):</span>
                <span class="c1"># this means variables from expressions are subset of the</span>
                <span class="c1"># block, and there is no point to continue the search in</span>
                <span class="c1"># other blocks</span>
                <span class="n">block_vars_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersection</span>
                <span class="k">return</span> <span class="n">block_vars_dict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">block_vars_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersection</span>

        <span class="k">return</span> <span class="n">block_vars_dict</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._reformulate"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._reformulate">[docs]</a>    <span class="k">def</span> <span class="nf">_reformulate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs block-separable reformulation for the case if one block</span>
<span class="sd">        is identified. For that case it computes the blocks based on the</span>
<span class="sd">        nonlinear expressions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># handle objective</span>
        <span class="n">obj_name</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span><span class="n">Objective</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_find_separable_sub_expr_and_replace</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>

        <span class="c1"># handle constraints</span>
        <span class="k">for</span> <span class="n">con_name</span><span class="p">,</span> <span class="n">con_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span>
                <span class="n">Constraint</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># avoid checking already reformulated constraints</span>
            <span class="k">if</span> <span class="s1">&#39;new&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">con_name</span><span class="p">:</span>
                <span class="c1"># if all variables belong to the same block, then we don&#39;t do</span>
                <span class="c1"># the reformulation</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con_obj</span><span class="p">,</span> <span class="n">IndexedConstraint</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">con_obj</span><span class="p">:</span>
                        <span class="n">blocks_var_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_block_expr</span><span class="p">(</span>
                            <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks_var_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_find_separable_sub_expr_and_replace</span><span class="p">(</span>
                                <span class="n">con_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blocks_var_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_block_expr</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks_var_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_find_separable_sub_expr_and_replace</span><span class="p">(</span><span class="n">con_obj</span><span class="o">.</span><span class="n">body</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._find_separable_sub_expr_and_replace"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._find_separable_sub_expr_and_replace">[docs]</a>    <span class="k">def</span> <span class="nf">_find_separable_sub_expr_and_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursive function for walking through the expression trees and</span>
<span class="sd">        substituting the nonlinear expressions which belong to the one block</span>
<span class="sd">        by a new variable</span>

<span class="sd">        :param expr: Expression which is processed</span>
<span class="sd">        :type expr: ProductExpression, SumExpression, \</span>
<span class="sd">        UnaryFunctionExpression, \ PowExpression, DivisionExpression, \</span>
<span class="sd">        NegationExpression, AbsExpression, MonomialTermExpression, Var</span>
<span class="sd">        :return: Block id to which this expression belongs. For some \</span>
<span class="sd">        subexpressions that should not be substituted None is returned.</span>
<span class="sd">        :rtype: int, None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">SumExpression</span><span class="p">:</span>
            <span class="n">local_expr</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">))}</span>
            <span class="n">indices_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_separable_sub_expr_and_replace</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">local_expr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">term</span>
                    <span class="n">indices_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># reformulation</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_to_remove</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">)</span> <span class="k">if</span>
                               <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices_to_remove</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">local_expr</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">local_expr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># create new variable</span>
                        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_bounds_new_vars</span><span class="p">(</span>
                            <span class="n">local_expr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                        <span class="n">new_variable_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_new_var</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span>
                                                                 <span class="n">block_id</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_create_local_nonlin_constraint</span><span class="p">(</span><span class="n">local_expr</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                                             <span class="n">new_variable_name</span><span class="p">)</span>
                        <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">new_variable_name</span><span class="p">))</span>
                <span class="n">expr</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">NegationExpression</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_separable_sub_expr_and_replace</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>

            <span class="c1"># reformulation</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># create new variable</span>
                <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_bounds_new_vars</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="n">new_variable_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_new_var</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span>
                                                         <span class="n">block_id</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_local_nonlin_constraint</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">new_variable_name</span><span class="p">)</span>
                <span class="n">expr</span><span class="o">.</span><span class="n">_args_</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">new_variable_name</span><span class="p">),)</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">MonomialTermExpression</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">DivisionExpression</span> <span class="ow">or</span> \
                <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">PowExpression</span> \
                <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">UnaryFunctionExpression</span><span class="p">:</span>
            <span class="n">blocks_vars_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_block_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="c1"># it is expected that dictionary will have one key, and we need</span>
            <span class="c1"># exactly this key</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">blocks_vars_dict</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">ProductExpression</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="nb">any</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">SumExpression</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">SumExpression</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_find_separable_sub_expr_and_replace</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blocks_vars_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_block_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="c1"># it is expected that dictionary will have one key, and we need</span>
                <span class="c1"># exactly this key</span>
                <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">blocks_vars_dict</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">AbsExpression</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Dev: abs expressions are not supported yet&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._compute_number_of_defined_blocks"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._compute_number_of_defined_blocks">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_number_of_defined_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the number of blocks in the model. This includes also root block</span>
<span class="sd">        (any Pyomo model has at least one block).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_defined_blocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">block_data_objects</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_defined_blocks</span> <span class="o">=</span> <span class="n">number_defined_blocks</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._comp_bounds_new_vars"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._comp_bounds_new_vars">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_comp_bounds_new_vars</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes bounds of new variables based on expression</span>

<span class="sd">        :param expr: Expression for which the bounds are computed</span>
<span class="sd">        :type expr: Expression</span>
<span class="sd">        :return: Upper and lower bound of the expression</span>
<span class="sd">        :rtype: (int, int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_model</span> <span class="o">=</span> <span class="n">ConcreteModel</span><span class="p">()</span>
        <span class="n">var_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">identify_variables</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="n">substitute_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lb</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">var</span><span class="o">.</span><span class="n">ub</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var_object</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">lb</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">ub</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">lb</span><span class="p">)</span>
                <span class="n">new_model</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">var_object</span><span class="p">)</span>
                <span class="n">substitute_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">var_object</span>  <span class="c1"># for replacing expressions is necessary</span>

        <span class="c1"># objects should the same in the model and expression</span>
        <span class="n">new_expr</span> <span class="o">=</span> <span class="n">replace_expressions</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span>
                                       <span class="n">substitute_map</span><span class="p">)</span>
        <span class="n">new_model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">new_expr</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">minimize</span><span class="p">)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;scip&#39;</span><span class="p">)</span>

        <span class="c1"># add termination condition</span>
        <span class="n">f_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;scip.set&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;limits/time = 2&quot;</span><span class="p">)</span>
        <span class="n">f_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">new_model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Message</span> <span class="o">==</span> <span class="s1">&#39;time limit reached&#39;</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>

        <span class="n">new_model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">sense</span> <span class="o">=</span> <span class="n">maximize</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">new_model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Message</span> <span class="o">==</span> <span class="s1">&#39;time limit reached&#39;</span><span class="p">:</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;scip.set&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._create_new_var"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._create_new_var">[docs]</a>    <span class="k">def</span> <span class="nf">_create_new_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">block_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new variable and adds it to the block list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_variable</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span>
                           <span class="n">initialize</span><span class="o">=</span><span class="n">lower</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">new_variable_name</span> <span class="o">=</span> <span class="s1">&#39;x_new</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">new_variable_name</span><span class="p">,</span> <span class="n">new_variable</span><span class="p">)</span>

        <span class="c1"># add new variable to block list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_variable_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_variable_name</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._create_local_nonlin_constraint"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._create_local_nonlin_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">_create_local_nonlin_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs_expr</span><span class="p">,</span> <span class="n">rhs_var_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates local nonlinear constraints</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nconstraints</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">new_con</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">lhs_expr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">rhs_var_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="s1">&#39;cnew</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nconstraints</span><span class="p">),</span> <span class="n">new_con</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyomoModelDecomposer._estimate_var_bounds"><a class="viewcode-back" href="../../../sources/generated/decogo.model.model_decomposer.html#decogo.model.model_decomposer.PyomoModelDecomposer._estimate_var_bounds">[docs]</a>    <span class="k">def</span> <span class="nf">_estimate_var_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimates the bounds of the unbounded variables:</span>

<span class="sd">        * if :math:`x_i` has no lower bound, \</span>
<span class="sd">         then :math:`\\underline{x}_i = \\min x_i, x \\in P \\cap X`</span>
<span class="sd">        * if :math:`x_i` has no upper bound, then \</span>
<span class="sd">        :math:`\\overline{x}_i = \\max x_i, x \\in P \\cap X`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># save objective</span>
        <span class="n">obj_name</span><span class="p">,</span> <span class="n">obj_old</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span><span class="n">Objective</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">del_component</span><span class="p">(</span><span class="n">obj_name</span><span class="p">)</span>

        <span class="c1"># set settings for scip with root node and aggressive heuristics</span>

        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;scip.set&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;limits/nodes = 1 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;limits/time = 5 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;presolving/restartfac = 0.03 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;presolving/restartminred = 0.06 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;constraints/setppc/cliquelifting = TRUE </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;presolving/boundshift/maxrounds = -1 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;presolving/dualagg/maxrounds = -1 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;presolving/tworowbnd/maxrounds = -1 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;presolving/redvub/maxrounds = -1 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;presolving/implfree/maxrounds = -1 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;propagating/probing/maxuseless = 1500 </span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;propagating/probing/maxtotaluseless = 75&quot;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">opt</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;scip&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">block_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">block_data_objects</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_obj</span> <span class="ow">in</span> <span class="n">block_obj</span><span class="o">.</span><span class="n">component_map</span><span class="p">(</span><span class="n">Var</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">var_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">ScalarVar</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var_obj</span><span class="o">.</span><span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">var_obj</span><span class="o">.</span><span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">var_obj</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">var_obj</span><span class="o">.</span><span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># minimizing</span>
                            <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="s2">&quot;Dual Bound&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                    <span class="n">lb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

                            <span class="c1"># update bound</span>
                            <span class="n">var_obj</span><span class="o">.</span><span class="n">setlb</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">var_obj</span><span class="o">.</span><span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># maximizing</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="s2">&quot;Dual Bound&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                    <span class="n">ub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

                            <span class="c1"># update bound</span>
                            <span class="n">var_obj</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">del_component</span><span class="p">(</span><span class="s1">&#39;obj&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">var_obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">IndexedVar</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">var_obj</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">var_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> \
                                <span class="n">var_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">var_obj</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

                            <span class="k">if</span> <span class="n">var_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># minimizing</span>
                                <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="s2">&quot;Dual Bound&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                        <span class="n">lb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

                                <span class="c1"># update bound</span>
                                <span class="n">var_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">setlb</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">var_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># maximizing</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                                <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="s2">&quot;Dual Bound&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                        <span class="n">ub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

                                <span class="c1"># update bound</span>
                                <span class="n">var_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">del_component</span><span class="p">(</span><span class="s1">&#39;obj&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="s1">&#39;obj&#39;</span><span class="p">,</span>
                                 <span class="n">obj_old</span><span class="p">)</span>  <span class="c1"># add old objective component back</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;scip.set&quot;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Pavlo Muts, Ouyang Wu and Ivo Nowak.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>