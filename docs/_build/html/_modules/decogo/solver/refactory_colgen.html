

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>decogo.solver.refactory_colgen &mdash; Decogo 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Decogo
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/example.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/modules.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/classes.html">Class inheritance diagram</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Decogo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>decogo.solver.refactory_colgen</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for decogo.solver.refactory_colgen</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Class which implements Column Generation with user-defined input model&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">decogo.solver.settings</span> <span class="kn">import</span> <span class="n">Settings</span>
<span class="kn">from</span> <span class="nn">decogo.util.block_vector</span> <span class="kn">import</span> <span class="n">BlockVector</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;decogo&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="RefactoryColGen"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen">[docs]</a><span class="k">class</span> <span class="nc">RefactoryColGen</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class which implements Column Generation algorithm with user-defined \</span>
<span class="sd">    input model</span>

<span class="sd">    :param problem: Decomposed problem class, which stores all input data</span>
<span class="sd">    :type problem: DecomposedProblem</span>
<span class="sd">    :param settings: Settings class</span>
<span class="sd">    :type settings: Settings</span>
<span class="sd">    :param result: Class which stores the results</span>
<span class="sd">    :type result: Results</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RefactoryColGen.__init__"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor method&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span></div>

<div class="viewcode-block" id="RefactoryColGen.solve"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inner approximation algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ia_init</span><span class="p">()</span>

        <span class="c1"># initial column generation</span>
        <span class="n">tic_init_cg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">i_find_sol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># find feasible solution and eliminate slacks</span>
            <span class="c1"># in IA master problem</span>
            <span class="n">i_find_sol</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_generation</span><span class="p">(</span><span class="n">approx_solver</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># solve subproblems</span>
            <span class="c1"># approximately</span>
            <span class="n">time_cg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time used for init CG &#39;</span>
                        <span class="s1">&#39;in iter </span><span class="si">{0}</span><span class="s1">: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span> <span class="n">time_cg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span> <span class="o">+=</span> <span class="n">time_cg</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time: --</span><span class="si">{0}</span><span class="s1">-- seconds&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="c1"># find solution performed always in the beginning</span>
            <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_solution_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">)</span>
            <span class="n">time_find_solution</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time used for init FindSol &#39;</span>
                        <span class="s1">&#39;in iter </span><span class="si">{0}</span><span class="s1">: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span> <span class="n">time_find_solution</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span> <span class="o">+=</span> <span class="n">time_find_solution</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time: --</span><span class="si">{0}</span><span class="s1">-- seconds&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">primal_bound</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found the first feasible solution&#39;</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;IA obj. val: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span><span class="p">))</span>

                <span class="k">break</span>

        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># apply cg_fast_fw or approx_cg</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_fast_fw</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_generation_fast_fw</span><span class="p">()</span>
                <span class="n">time_init_cg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time used for init cg fast fw &#39;</span>
                            <span class="s1">&#39;in iter </span><span class="si">{0}</span><span class="s1">: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">time_init_cg</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_generation</span><span class="p">(</span><span class="n">approx_solver</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">time_init_cg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time used for init approx cg &#39;</span>
                            <span class="s1">&#39;in iter </span><span class="si">{0}</span><span class="s1">: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">time_init_cg</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span> <span class="o">+=</span> <span class="n">time_init_cg</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time: --</span><span class="si">{0}</span><span class="s1">-- seconds&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">time_init_cg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic_init_cg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">CG relaxation obj. value &#39;</span>
                    <span class="s1">&#39;in iter </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span> <span class="o">*</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time used for total init CG &#39;</span>
                    <span class="s1">&#39;in iter </span><span class="si">{0}</span><span class="s1">: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span><span class="o">.</span>
                    <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span> <span class="n">time_init_cg</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time at CG iter </span><span class="si">{0}</span><span class="s1">: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                            <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>

        <span class="c1"># flag which says if reduced cost is positive and we can stop</span>
        <span class="n">stop_by_cg_converg</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># init hat K</span>
        <span class="n">hat_k_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">)</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">sub_models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">linear</span>
                     <span class="ow">is</span> <span class="kc">False</span><span class="p">}</span>

        <span class="n">time_i_loop_set</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">tic_i_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">num_subproblems_solved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_minlp_problems</span>

            <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_generation</span><span class="p">(</span><span class="n">hat_k_set</span><span class="p">)</span>
            <span class="n">time_column_generation</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CG relaxation obj. value in iter </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span> <span class="o">*</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Time used for CG: --</span><span class="si">{0}</span><span class="s1">-- seconds&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_column_generation</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span> <span class="o">+=</span> <span class="n">time_column_generation</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time at CG iter </span><span class="si">{0}</span><span class="s1">: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                                <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Num of MINLP subproblems solved &#39;</span>
                        <span class="s1">&#39;in iter loop *</span><span class="si">{0}</span><span class="s1">*   </span><span class="si">{1}</span><span class="s1">&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_minlp_problems</span> <span class="o">-</span>
                                <span class="n">num_subproblems_solved</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Total number of minlp subproblems &#39;</span>
                        <span class="s1">&#39;solved in iter </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_minlp_problems</span><span class="p">))</span>

            <span class="n">column_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get_inner_points_size</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                             <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">)]</span>
            <span class="n">column_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get_inner_points_size</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                             <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Total number of columns &#39;</span>
                        <span class="s1">&#39;in iter </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                                <span class="n">column_sum</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Columns in blocks &#39;</span>
                        <span class="s1">&#39;in iter </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span> <span class="n">column_blocks</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time used for CG in iter &#39;</span>
                        <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                            <span class="n">time_column_generation</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CG regarding all blocks&#39;</span><span class="p">)</span>
            <span class="c1"># col/cut generation for all blocks; calculate reduced cost</span>
            <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">z</span><span class="p">,</span> <span class="n">x_ia</span><span class="p">,</span> <span class="n">w_ia</span><span class="p">,</span> <span class="n">slacks</span><span class="p">,</span> <span class="n">duals</span><span class="p">,</span> <span class="n">obj_value_ia</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">master_problems</span><span class="o">.</span><span class="n">solve_ia</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lp_solver</span><span class="p">)</span>

            <span class="n">reduced_cost_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">1</span><span class="p">],</span> <span class="n">duals</span><span class="p">))</span>

            <span class="c1"># reduce block set based on the reduced cost</span>
            <span class="n">hat_k_set</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">sub_models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">linear</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">delta_k</span><span class="p">,</span> <span class="n">new_point</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">generate_column</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">reduced_cost_direction</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">delta_k</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">1e-3</span><span class="p">:</span>
                        <span class="n">hat_k_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

            <span class="n">time_column_generation</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time used for CG for all blocks: --</span><span class="si">{0}</span><span class="s1">-- seconds&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time_column_generation</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span> <span class="o">+=</span> <span class="n">time_column_generation</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time: --</span><span class="si">{0}</span><span class="s1">-- seconds&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>

            <span class="c1"># check if reduced block set is empty.</span>
            <span class="c1"># if it is empty then we stop, since for all blocks reduced cost</span>
            <span class="c1"># was positive</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hat_k_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_check_convergence</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CG converges, checking the convergence by &#39;</span>
                                <span class="s1">&#39;exact subproblem solving&#39;</span><span class="p">)</span>
                    <span class="c1"># solve again the subproblems regarding the same direction</span>
                    <span class="c1"># until optimality</span>
                    <span class="c1"># if here reduced cost is positive, then we can stop,</span>
                    <span class="c1"># otherwise we should continue</span>
                    <span class="n">hat_k_set</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">sub_models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">linear</span> \
                                <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="c1"># heuristic=False forces SCIP to use default</span>
                            <span class="c1"># settings, i.e it tries to solve the subproblem</span>
                            <span class="c1"># until optimality not clear whether it will slow</span>
                            <span class="c1"># down everything too much maybe here is better</span>
                            <span class="c1"># to use just stricter settings for SCIP</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">delta_k</span><span class="p">,</span> <span class="n">new_point</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">generate_column</span><span class="p">(</span><span class="n">k</span><span class="p">,</span>
                                                     <span class="n">reduced_cost_direction</span><span class="p">,</span>
                                                     <span class="n">heuristic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">delta_k</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">1e-3</span><span class="p">:</span>
                                <span class="n">hat_k_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hat_k_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">stop_by_cg_converg</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stop_by_cg_converg</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># primal heuristics</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_find_solution</span><span class="p">:</span>
                <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">find_solution</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">)</span>
                <span class="n">time_find_solution</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time used for FindSol in iter </span><span class="si">{0}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span><span class="o">.</span>
                            <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                                   <span class="n">time_find_solution</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span> <span class="o">+=</span> <span class="n">time_find_solution</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time at FindSol iter </span><span class="si">{0}</span><span class="s1">: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                                    <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------&#39;</span><span class="p">)</span>

            <span class="c1"># main iteration time counting</span>
            <span class="n">time_i_loop</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic_i_start</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">time_i_loop_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_i_loop</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Total time used in iter </span><span class="si">{0}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;: --</span><span class="si">{1}</span><span class="s1">-- seconds&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span><span class="p">,</span>
                                                    <span class="n">time_i_loop</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">main_iterations</span> <span class="o">==</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_max_main_iter</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Iteration limit&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">stop_by_cg_converg</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CG converged&#39;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">num_of_columns_after_cg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get_inner_points_size</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">total_number_columns</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get_inner_points_size</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">total_sub_problem_number</span> \
            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_minlp_problems</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_unfixed_nlp_problems</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_fixed_nlp_problems</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sub_problem_number_after_cg</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">total_sub_problem_number</span></div>

<div class="viewcode-block" id="RefactoryColGen.ia_init"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.ia_init">[docs]</a>    <span class="k">def</span> <span class="nf">ia_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization of inner outer approximation</span>

<span class="sd">        :param duals: Initial dual vector for initialization</span>
<span class="sd">        :type duals: ndarray</span>
<span class="sd">        :return: Solution of MIP projection master problem</span>
<span class="sd">        :rtype: BlockVector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initialization&#39;</span><span class="p">)</span>

        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># initial dual vector</span>
        <span class="k">if</span> <span class="n">duals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">duals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span>
                             <span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">num_of_global_cuts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sub_gradient</span><span class="p">(</span><span class="n">duals</span><span class="p">)</span>

        <span class="n">time_sub_gradient</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Time used for SubGradient: --</span><span class="si">{0}</span><span class="s1">-- seconds&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_sub_gradient</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span> <span class="o">+=</span> <span class="n">time_sub_gradient</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RefactoryColGen.column_generation"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.column_generation">[docs]</a>    <span class="k">def</span> <span class="nf">column_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset_of_blocks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">approx_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs column generation steps (see paper)</span>

<span class="sd">        :param subset_of_blocks: apply column generation for reduced block set</span>
<span class="sd">        :type subset_of_blocks: list or None</span>
<span class="sd">        :param approx_solver: enables approximate solving of subproblems in \</span>
<span class="sd">        column generation</span>
<span class="sd">        :type approx_solver: bool</span>
<span class="sd">        :return: Dual solution from IA master problem regarding global \</span>
<span class="sd">        constraints</span>
<span class="sd">        :rtype: ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">=======================================================&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">approx_solver</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Column generation: approximated subproblem solving&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Column generation&#39;</span><span class="p">)</span>
        <span class="n">new_columns_generated</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span>
        <span class="n">num_minlp_problems_solved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_minlp_problems</span>

        <span class="k">if</span> <span class="n">subset_of_blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="n">subset_of_blocks</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">)</span>
                      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">sub_models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">linear</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">}</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

            <span class="n">z</span><span class="p">,</span> <span class="n">x_ia</span><span class="p">,</span> <span class="n">w_ia</span><span class="p">,</span> <span class="n">slacks</span><span class="p">,</span> <span class="n">duals</span><span class="p">,</span> <span class="n">obj_value_ia</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">master_problems</span><span class="o">.</span><span class="n">solve_ia</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lp_solver</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span> <span class="o">=</span> <span class="n">obj_value_ia</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">initial_obj_value_ia</span> <span class="o">=</span> <span class="n">obj_value_ia</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initial CG objective value: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span> <span class="o">*</span> <span class="n">initial_obj_value_ia</span><span class="p">))</span>

            <span class="n">max_slack_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">slacks</span><span class="p">)</span>
            <span class="n">sum_slack_values</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">slacks</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: &lt;15}{1: &lt;30}{2: &lt;30}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="si">{3: &lt;30}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;CG iter&#39;</span><span class="p">,</span> <span class="s1">&#39;IA obj. value&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;max slack value IA&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;sum slack values IA&#39;</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: &lt;15}{1: &lt;30}{2: &lt;30}</span><span class="s1">&#39;&#39;</span><span class="si">{3: &lt;30}</span><span class="s1">&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span> <span class="o">*</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span><span class="p">,</span>
                                <span class="n">max_slack_value</span><span class="p">,</span> <span class="n">sum_slack_values</span><span class="p">))</span>

            <span class="n">reduced_cost_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">1</span><span class="p">],</span> <span class="n">duals</span><span class="p">))</span>

            <span class="c1"># generate new columns</span>
            <span class="n">generate_column_time_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">reduced_cost_list</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># generate columns according to dual values</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">reduced_cost_list</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">new_point</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_column</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">reduced_cost_direction</span><span class="p">,</span>
                                         <span class="n">approx_solver</span><span class="o">=</span><span class="n">approx_solver</span><span class="p">,</span>
                                         <span class="n">x_k</span><span class="o">=</span><span class="n">x_ia</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="n">generate_column_time_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_point</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">new_columns_generated</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># generate columns according to non-zero slacks</span>
            <span class="n">generate_column_slack_time_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">max_slack_value</span> <span class="o">&gt;</span> <span class="mf">1e-1</span><span class="p">:</span>

                <span class="n">z</span><span class="p">,</span> <span class="n">x_ia</span><span class="p">,</span> <span class="n">w_ia</span><span class="p">,</span> <span class="n">slacks</span><span class="p">,</span> <span class="n">duals</span><span class="p">,</span> <span class="n">obj_value_ia</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">master_problems</span><span class="o">.</span><span class="n">solve_ia</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lp_solver</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span> <span class="o">=</span> <span class="n">obj_value_ia</span>
                <span class="n">max_slack_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">slacks</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">max_slack_value</span> <span class="o">&gt;</span> <span class="mf">1e-1</span><span class="p">:</span>

                    <span class="n">slack_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slack_directions</span><span class="p">(</span><span class="n">slacks</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">new_point</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">generate_column</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">slack_direction</span><span class="p">,</span>
                                                 <span class="n">approx_solver</span><span class="o">=</span><span class="n">approx_solver</span><span class="p">,</span>
                                                 <span class="n">x_k</span><span class="o">=</span><span class="n">x_ia</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                        <span class="n">generate_column_slack_time_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_point</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">new_columns_generated</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_max_iter</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Iteration limit&#39;</span><span class="p">)</span>
                <span class="c1"># logger.info(&#39;Reduced cost: {0}&#39;</span>
                <span class="c1">#             .format(str(reduced_cost_list)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New columns added: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_columns_generated</span><span class="p">)))</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">1e-6</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span>
                    <span class="n">reduced_cost_list</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reduced costs greater than zero&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New columns added: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_columns_generated</span><span class="p">)))</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">num_cg_iterations</span> <span class="o">+=</span> <span class="n">i</span>

        <span class="c1"># number of MINLP subproblems during CG</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;number of minlp subproblems &#39;</span>
            <span class="s1">&#39;solved during CG: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_minlp_problems</span> <span class="o">-</span>
                                           <span class="n">num_minlp_problems_solved</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">=======================================================&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">duals</span></div>

<div class="viewcode-block" id="RefactoryColGen.column_generation_fast_fw"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.column_generation_fast_fw">[docs]</a>    <span class="k">def</span> <span class="nf">column_generation_fast_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Performs fast FW column generation steps (see paper) &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fast column generation&#39;</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># solve ia master problem</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">x_ia</span><span class="p">,</span> <span class="n">w_ia</span><span class="p">,</span> <span class="n">slacks</span><span class="p">,</span> <span class="n">duals</span><span class="p">,</span> <span class="n">obj_value_ia</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">master_problems</span><span class="o">.</span><span class="n">solve_ia</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lp_solver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span> <span class="o">=</span> <span class="n">obj_value_ia</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">1</span><span class="p">],</span> <span class="n">duals</span><span class="p">))</span>

        <span class="c1"># it is always good idea to have a look at the existing code and</span>
        <span class="c1"># make the code as simple as possible to read</span>
        <span class="n">tilde_w</span> <span class="o">=</span> <span class="n">BlockVector</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">sub_models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">linear</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">column</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get_min_column</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
                <span class="n">tilde_w</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tilde_w</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">w_ia</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

        <span class="n">v_plus</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tilde_w</span><span class="p">)</span>

        <span class="c1"># todo: refactor this, make use of BlockVector,</span>
        <span class="c1"># if neccessary extend BlockVector class</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">vector</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tilde_w</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tilde_w_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tilde_w_array</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tilde_w_array</span><span class="p">,</span>
                                    <span class="n">vector</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">))))</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">vector</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v_plus</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">v_plus_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_plus_array</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">v_plus_array</span><span class="p">,</span>
                                    <span class="n">vector</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">))))</span>
        <span class="n">sigma_cg</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">duals</span><span class="p">)</span>
        <span class="n">global_cuts_rhs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">global_cuts</span><span class="p">:</span>
            <span class="n">global_cuts_rhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cut</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>
        <span class="n">global_cuts_rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">global_cuts_rhs</span><span class="p">)</span>

        <span class="n">tic_fast_cg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">num_unfixed_nlp_problems_solved</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_unfixed_nlp_problems</span>

        <span class="n">gamma_cg_plus</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: &lt;10}{1: &lt;30}</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="si">{2: &lt;30}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;iter&#39;</span><span class="p">,</span> <span class="s1">&#39;IA obj. value&#39;</span><span class="p">,</span> <span class="s1">&#39;slacks&#39;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: &lt;10}{1: &lt;30}</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="si">{2: &lt;30}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">obj_value_ia</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span><span class="p">,</span>
                                      <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="n">slacks</span><span class="p">))))</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="n">slacks</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;IA obj. val: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">obj_value_ia</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

        <span class="n">new_columns_generated_cumulative</span> <span class="o">=</span> \
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">)</span>
             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">sub_models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">linear</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">}</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">generate_column_time_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">reduced_cost_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">r_cg</span> <span class="o">=</span> <span class="n">BlockVector</span><span class="p">()</span>
            <span class="n">new_columns_generated</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
                <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_fast_approx</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">reduced_cost_list</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">new_point</span><span class="p">,</span> <span class="n">r_k</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">local_solve_subproblem</span><span class="p">(</span>
                            <span class="n">k</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x_k</span><span class="o">=</span><span class="n">x_ia</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">reduced_cost_list</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">new_point</span><span class="p">,</span> <span class="n">r_k</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">generate_column</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
                <span class="n">generate_column_time_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span>
                                                     <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">r_cg</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r_k</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r_cg</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">w_ia</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="c1"># logger.info(</span>
                <span class="c1">#     &#39;added r_{0} in iter {1}&#39;.format(k, i))</span>
                <span class="k">if</span> <span class="n">new_point</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># count in current iteration</span>
                    <span class="n">new_columns_generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># cumulative count</span>
                    <span class="n">new_columns_generated_cumulative</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_columns_generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">item</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_columns_generated</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No new columns generated in the current iteration&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">z</span><span class="p">,</span> <span class="n">x_ia</span><span class="p">,</span> <span class="n">w_ia</span><span class="p">,</span> <span class="n">slacks</span><span class="p">,</span> <span class="n">duals</span><span class="p">,</span> <span class="n">obj_value_ia</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">master_problems</span><span class="o">.</span><span class="n">solve_ia</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lp_solver</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span> <span class="o">=</span> <span class="n">obj_value_ia</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{0: &lt;10}{1: &lt;30}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="si">{2: &lt;30}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;iter&#39;</span><span class="p">,</span> <span class="s1">&#39;IA obj. value&#39;</span><span class="p">,</span> <span class="s1">&#39;slacks&#39;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: &lt;10}{1: &lt;30}</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="si">{2: &lt;30}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
                                          <span class="n">obj_value_ia</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span><span class="p">,</span>
                                          <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="n">slacks</span><span class="p">))))</span>

            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="n">slacks</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;IA obj. val: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">obj_value_ia</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">current_used_time</span> <span class="o">+</span>
                                               <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

            <span class="c1"># use column</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">vector</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r_cg</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r_cg_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r_cg_array</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">r_cg_array</span><span class="p">,</span>
                                        <span class="n">vector</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">))))</span>

            <span class="c1"># the operations add, substract and multiplication by scalar is</span>
            <span class="c1"># implemented in BlockVector class. Maybe it is easier to use them</span>
            <span class="c1"># The implementation of summing the components of BlockVector</span>
            <span class="c1"># can implemented and added there</span>

            <span class="c1"># determining the step size</span>
            <span class="n">coeff_w_r_array</span> <span class="o">=</span> <span class="n">r_cg_array</span> <span class="o">-</span> <span class="n">tilde_w_array</span>
            <span class="n">coeff_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeff_w_r_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                                   <span class="o">-</span> <span class="n">global_cuts_rhs</span><span class="p">),</span> <span class="n">sigma_cg</span><span class="p">)</span>
            <span class="n">coeff_a</span> <span class="o">=</span> \
                <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff_a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeff_w_r_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">coeff_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sigma_cg</span><span class="p">,</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tilde_w_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">coeff_b</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeff_b</span><span class="p">,</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeff_w_r_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">coeff_b</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeff_w_r_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">coeff_a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># tilda_w equals nu_plus</span>
                <span class="c1"># logger.info(&#39;tilda_w equals nu_plus&#39;)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta_cg</span> <span class="o">=</span> <span class="o">-</span> <span class="n">coeff_b</span> <span class="o">/</span> <span class="n">coeff_a</span>
            <span class="c1"># logger.info(&#39;theta_cg: {0}&#39;.format(theta_cg))</span>
            <span class="k">if</span> <span class="n">theta_cg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># update step</span>
            <span class="n">add_term</span> <span class="o">=</span> <span class="n">theta_cg</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_cg_array</span> <span class="o">-</span> <span class="n">tilde_w_array</span><span class="p">)</span>
            <span class="n">v_array</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v_plus_array</span><span class="p">)</span>
            <span class="n">v_plus_array</span> <span class="o">=</span> <span class="n">tilde_w_array</span> <span class="o">+</span> <span class="n">add_term</span>
            <span class="c1"># fast FW step</span>
            <span class="n">gamma_cg</span> <span class="o">=</span> <span class="n">gamma_cg_plus</span>
            <span class="n">gamma_cg_plus</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">gamma_cg</span> <span class="o">**</span> <span class="mi">2</span>
                                                 <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">tilde_w_array</span> <span class="o">=</span> <span class="n">v_plus_array</span> <span class="o">+</span> \
                            <span class="p">(</span><span class="n">gamma_cg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">gamma_cg_plus</span> <span class="o">*</span> \
                            <span class="p">(</span><span class="n">v_plus_array</span> <span class="o">-</span> <span class="n">v_array</span><span class="p">)</span>

            <span class="n">gap</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">sub_models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">linear</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">gap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="p">(</span><span class="n">tilde_w_array</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                                                <span class="n">r_cg_array</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="c1"># logger.info(&#39;Value of gap (g_k):&#39;)</span>
            <span class="c1"># logger.info(gap)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of new columns in the current iteration:&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">new_columns_generated</span><span class="p">)</span>

            <span class="c1"># update direction</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sigma_cg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tilde_w_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span>
                                                         <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span>
                                        <span class="n">global_cuts_rhs</span><span class="p">)</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_fast_fw_max_iter</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">New columns in FastCG:&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_columns_generated_cumulative</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="c1"># number of unfixed nlp subproblems during CG</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;number of unfixed nlp subproblems &#39;</span>
                    <span class="s1">&#39;solved during CG: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_unfixed_nlp_problems</span> <span class="o">-</span>
                            <span class="n">num_unfixed_nlp_problems_solved</span><span class="p">))</span>
        <span class="n">time_fast_cg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic_fast_cg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time used for solving subproblem&#39;</span>
                    <span class="s1">&#39;: --</span><span class="si">{0}</span><span class="s1">-- seconds&#39;</span><span class="o">.</span>
                    <span class="nb">format</span><span class="p">(</span><span class="n">time_fast_cg</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RefactoryColGen.sub_gradient"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.sub_gradient">[docs]</a>    <span class="k">def</span> <span class="nf">sub_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction_vector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs sub-gradient iterations</span>

<span class="sd">        :param direction_vector: Initial vector for sub-gradient iterations</span>
<span class="sd">        :type direction_vector: ndarray</span>
<span class="sd">        :return: Final direction vector</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">BlockVector</span><span class="p">()</span>

        <span class="c1"># create an array of rhs of global constraints</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">num_of_global_cuts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">cut</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">global_cuts</span><span class="p">):</span>
            <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cut</span><span class="o">.</span><span class="n">rhs</span>

        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Subgradient steps&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: &lt;15}{1: &lt;30}{2: &lt;30}</span><span class="s1">&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Subgra.iter&#39;</span><span class="p">,</span> <span class="s1">&#39;Lagrange bound&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">))</span>

        <span class="n">direction_vector_prev</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">direction_vector</span><span class="p">)</span>
        <span class="n">lag_sol_prev</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>

        <span class="n">violation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">num_of_global_cuts</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_sub_gradient_max_iter</span><span class="p">:</span>
            <span class="n">time_generate_column_sub_gradient_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">new_columns_generated</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span>
            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lag_sol</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction_vector</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
                <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">feasible_point</span><span class="p">,</span> <span class="n">primal_bound</span><span class="p">,</span> <span class="n">reduced_cost</span><span class="p">,</span> <span class="n">new_point</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_column</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
                <span class="n">time_generate_column_sub_gradient_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_point</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">new_columns_generated</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">y</span><span class="o">.</span><span class="n">set_block</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">feasible_point</span><span class="p">)</span>
                <span class="n">lag_sol</span> <span class="o">+=</span> <span class="n">primal_bound</span>
            <span class="n">lag_sol</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">direction_vector</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: &lt;15}{1: &lt;30}{2: &lt;30}</span><span class="s1">&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sense</span> <span class="o">*</span> <span class="n">lag_sol</span><span class="p">,</span> <span class="n">alpha</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">violation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">eval_viol_lin_global_constraints</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

                <span class="n">lag_sol_prev</span> <span class="o">=</span> <span class="n">lag_sol</span>
                <span class="n">direction_vector_prev</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">direction_vector</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># update the step</span>
                <span class="k">if</span> <span class="n">lag_sol</span> <span class="o">&lt;=</span> <span class="n">lag_sol_prev</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">*=</span> <span class="mf">0.5</span>
                    <span class="n">direction_vector</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">direction_vector_prev</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">*=</span> <span class="mi">2</span>
                    <span class="n">violation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">eval_viol_lin_global_constraints</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

                    <span class="n">lag_sol_prev</span> <span class="o">=</span> <span class="n">lag_sol</span>
                    <span class="n">direction_vector_prev</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">direction_vector</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-1</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">violation</span><span class="p">):</span>
                <span class="c1"># if no violation, stop</span>
                <span class="k">break</span>

            <span class="c1"># update direction</span>
            <span class="n">direction_vector</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">violation</span>

        <span class="k">return</span> <span class="n">direction_vector</span></div>

<div class="viewcode-block" id="RefactoryColGen.generate_column"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.generate_column">[docs]</a>    <span class="k">def</span> <span class="nf">generate_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">heuristic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">approx_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">x_k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates the inner point (and corresponding column) either</span>
<span class="sd">        with MINLP sub-problem or with NLP sub-problem (too heuristically);</span>
<span class="sd">        adds valid local linear cut to heu_oa_master_problem if any</span>

<span class="sd">        :param block_id: Block identifier</span>
<span class="sd">        :type block_id: int</span>
<span class="sd">        :param direction: Direction in image space</span>
<span class="sd">        :type direction: ndarray</span>
<span class="sd">        :param heuristic: Indicates if the sub-problem must be solved \</span>
<span class="sd">        heuristically</span>
<span class="sd">        :type heuristic: bool</span>
<span class="sd">        :param approx_solver: enables approximate solving of subproblems in \</span>
<span class="sd">        column generation</span>
<span class="sd">        :type approx_solver: bool</span>
<span class="sd">        :param x_k: start_point for solving subproblems</span>
<span class="sd">        :type x_k: BlockVector or None</span>
<span class="sd">        :return: Inner point, primal bound, reduced cost of new point, \</span>
<span class="sd">        bool value indicating whether new point is generated and \</span>
<span class="sd">        corresponding column</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">approx_solver</span><span class="p">:</span>  <span class="c1"># approximate solve minlp subproblem</span>
            <span class="n">feasible_point</span><span class="p">,</span> <span class="n">primal_bound</span><span class="p">,</span> <span class="n">reduced_cost</span><span class="p">,</span> <span class="n">is_new_point</span><span class="p">,</span> \
             <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_solve_subproblem</span><span class="p">(</span>
                <span class="n">block_id</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x_k</span><span class="o">=</span><span class="n">x_k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_generate_columns_with_nlp</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">feasible_point</span><span class="p">,</span> <span class="n">primal_bound</span><span class="p">,</span> <span class="n">reduced_cost</span><span class="p">,</span> <span class="n">is_new_point</span><span class="p">,</span> \
                 <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_solve_subproblem</span><span class="p">(</span><span class="n">block_id</span><span class="p">,</span>
                                                      <span class="n">direction</span><span class="p">,</span>
                                                      <span class="n">x_k</span><span class="o">=</span><span class="n">x_k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reduced_cost</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">:</span>
                    <span class="n">feasible_point</span><span class="p">,</span> <span class="n">reduced_cost</span><span class="p">,</span> <span class="n">primal_bound</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> \
                     <span class="n">is_new_point</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">global_solve_subproblem</span><span class="p">(</span>
                         <span class="n">block_id</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">heuristic</span><span class="o">=</span><span class="n">heuristic</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feasible_point</span><span class="p">,</span> <span class="n">reduced_cost</span><span class="p">,</span> <span class="n">primal_bound</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">is_new_point</span><span class="p">,</span> \
                 <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_solve_subproblem</span><span class="p">(</span>
                    <span class="n">block_id</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">heuristic</span><span class="o">=</span><span class="n">heuristic</span><span class="p">)</span>

        <span class="n">reduced_cost</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">reduced_cost</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">feasible_point</span><span class="p">,</span> <span class="n">primal_bound</span><span class="p">,</span> <span class="n">reduced_cost</span><span class="p">,</span> <span class="n">is_new_point</span><span class="p">,</span> <span class="n">column</span></div>

<div class="viewcode-block" id="RefactoryColGen.global_solve_subproblem"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.global_solve_subproblem">[docs]</a>    <span class="k">def</span> <span class="nf">global_solve_subproblem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span>
                                <span class="n">dir_im_space</span><span class="p">,</span>
                                <span class="n">compute_reduced_cost</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">heuristic</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solves subproblem, adds inner point, \</span>
<span class="sd">        (either in compact form or in the original) and computes reduced cost \</span>
<span class="sd">        for the new inner point</span>

<span class="sd">        :param block_id: Block identifier</span>
<span class="sd">        :type block_id: int</span>
<span class="sd">        :param dir_im_space: Direction in image space</span>
<span class="sd">        :type dir_im_space: ndarray</span>
<span class="sd">        :param compute_reduced_cost: Indicates if reduced cost has to be \</span>
<span class="sd">        computed</span>
<span class="sd">        :type compute_reduced_cost: bool</span>
<span class="sd">        :param heuristic: Indicates if the sub-problem must be solved \</span>
<span class="sd">        heuristically</span>
<span class="sd">        :type heuristic: bool</span>
<span class="sd">        :return: Inner point (feasible point), reduced cost value, \</span>
<span class="sd">        primal bound of the sub-problem, dual bound of the sub-problem, \</span>
<span class="sd">        bool value indicating whether new inner point was generated, \</span>
<span class="sd">        corresponding column to the inner point</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_minlp_problems</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># can be None in case of initialization of the inner master problem</span>
        <span class="n">reduced_cost</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">is_new_point</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># transform into original space the direction</span>
        <span class="n">dir_orig_space</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">trans_into_orig_space</span><span class="p">(</span><span class="n">block_id</span><span class="p">,</span>
                                                           <span class="n">dir_im_space</span><span class="p">)</span>

        <span class="c1"># solve the sub-problem</span>
        <span class="n">feasible_point</span><span class="p">,</span> <span class="n">primal_bound</span><span class="p">,</span> <span class="n">dual_bound</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">sub_problems</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span><span class="o">.</span><span class="n">global_solve</span><span class="p">(</span>
                <span class="n">direction</span><span class="o">=</span><span class="n">dir_orig_space</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>

        <span class="n">column</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">compute_reduced_cost</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># compute reduced cost</span>

            <span class="c1"># get the best inner point with given direction</span>
            <span class="n">best_point</span><span class="p">,</span> <span class="n">best_obj_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get_min_inner_point</span><span class="p">(</span>
                <span class="n">block_id</span><span class="p">,</span> <span class="n">dir_orig_space</span><span class="p">)</span>
            <span class="n">reduced_cost</span> <span class="o">=</span> <span class="n">primal_bound</span> <span class="o">-</span> <span class="n">best_obj_val</span>  <span class="c1"># absolute reduced cost</span>

            <span class="k">if</span> <span class="n">reduced_cost</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># add the inner point with negative absolute reduced cost</span>
                <span class="n">is_new_point</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">add_inner_point</span><span class="p">(</span><span class="n">block_id</span><span class="p">,</span> <span class="n">feasible_point</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_new_point</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">add_inner_point</span><span class="p">(</span>
                    <span class="n">block_id</span><span class="p">,</span> <span class="n">feasible_point</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_min_inner_point_distance</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">trans_into_im_space</span><span class="p">(</span>
                <span class="n">block_id</span><span class="p">,</span> <span class="n">feasible_point</span><span class="p">)</span>

        <span class="c1"># check if subproblem is solved to optimality</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">primal_bound</span> <span class="o">-</span> <span class="n">dual_bound</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">primal_bound</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dual_bound</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gap</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">optimal_subproblems</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">feasible_point</span><span class="p">,</span> <span class="n">reduced_cost</span><span class="p">,</span> <span class="n">primal_bound</span><span class="p">,</span> <span class="n">dual_bound</span><span class="p">,</span> \
            <span class="n">is_new_point</span><span class="p">,</span> <span class="n">column</span></div>

<div class="viewcode-block" id="RefactoryColGen.get_slack_directions"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.get_slack_directions">[docs]</a>    <span class="k">def</span> <span class="nf">get_slack_directions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slacks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes new direction based on the slack values of IA master problem</span>

<span class="sd">        :param slacks: Slack values stored as a list of tuples</span>
<span class="sd">        :type slacks: list</span>
<span class="sd">        :return: New direction in image space</span>
<span class="sd">        :rtype: ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get maximum slack value</span>
        <span class="n">max_slack_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">slacks</span><span class="p">)</span>

        <span class="n">direction_image_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">num_of_global_cuts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">slack</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slacks</span><span class="p">):</span>
            <span class="c1"># check if slacks are zero</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">slack</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="nb">max</span><span class="p">(</span><span class="n">slack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">max_slack_value</span><span class="p">:</span>
                <span class="n">direction_image_space</span><span class="p">[</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">direction_image_space</span></div>

<div class="viewcode-block" id="RefactoryColGen.local_solve_subproblem"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.local_solve_subproblem">[docs]</a>    <span class="k">def</span> <span class="nf">local_solve_subproblem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">dir_im_space</span><span class="p">,</span> <span class="n">x_k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solves MINLP subproblem approximately, adds inner point \</span>
<span class="sd">        (either in compact form or in the original) and computes reduced cost</span>
<span class="sd">        for the new inner point</span>

<span class="sd">        :param block_id: Block identifier</span>
<span class="sd">        :type block_id: int</span>
<span class="sd">        :param dir_im_space: Direction in image space</span>
<span class="sd">        :type dir_im_space: ndarray</span>
<span class="sd">        :param x_k: start_point for solving subproblems</span>
<span class="sd">        :type x_k: BlockVector or None</span>
<span class="sd">        :return: Inner point (feasible point), reduced cost value, \</span>
<span class="sd">        primal bound of the sub-problem, dual bound of the sub-problem, \</span>
<span class="sd">        bool value indicating whether new inner point was generated, \</span>
<span class="sd">        corresponding column to the inner point</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_num_unfixed_nlp_problems</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">dir_orig_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">trans_into_orig_space</span><span class="p">(</span>
            <span class="n">block_id</span><span class="p">,</span> <span class="n">dir_im_space</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">x_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">best_point</span> <span class="o">=</span> <span class="n">x_k</span>
            <span class="n">best_point_obj_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dir_orig_space</span><span class="p">,</span> <span class="n">best_point</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_point</span><span class="p">,</span> <span class="n">best_point_obj_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get_min_inner_point</span><span class="p">(</span>
                <span class="n">block_id</span><span class="p">,</span> <span class="n">dir_orig_space</span><span class="p">)</span>

        <span class="c1"># solve the sub-problem</span>
        <span class="n">tilde_y</span><span class="p">,</span> <span class="n">new_point_obj_val</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sol_is_feasible</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">sub_problems</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span><span class="o">.</span><span class="n">local_solve</span><span class="p">(</span>
                <span class="n">direction</span><span class="o">=</span><span class="n">dir_orig_space</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>

        <span class="n">reduced_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">column</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">is_new_point</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">sol_is_feasible</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">reduced_cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_point_obj_val</span> <span class="o">-</span> <span class="n">best_point_obj_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">new_point_obj_val</span><span class="p">),</span>
                        <span class="nb">abs</span><span class="p">(</span><span class="n">best_point_obj_val</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>
            <span class="n">is_new_point</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">add_inner_point</span><span class="p">(</span>
                    <span class="n">block_id</span><span class="p">,</span> <span class="n">tilde_y</span><span class="p">,</span> <span class="n">min_inner_point_dist</span><span class="o">=</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cg_min_inner_point_distance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tilde_y</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_point_obj_val</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">tilde_y</span><span class="p">,</span> <span class="n">new_point_obj_val</span><span class="p">,</span> <span class="n">reduced_cost</span><span class="p">,</span> <span class="n">is_new_point</span><span class="p">,</span> <span class="n">column</span></div>

<div class="viewcode-block" id="RefactoryColGen.find_solution_init"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.find_solution_init">[docs]</a>    <span class="k">def</span> <span class="nf">find_solution_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iter_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to generate a feasible solution and therefore reducing</span>
<span class="sd">        the slacks to zero in innerMaster problem</span>

<span class="sd">        :param iter_index: number of main iteration when the method is called</span>
<span class="sd">        :type: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">=======================================================&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Find solution - init&#39;</span><span class="p">)</span>

        <span class="c1"># solve IA master problem</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">w_ia</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">obj_value_ia</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">master_problems</span><span class="o">.</span><span class="n">solve_ia</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lp_solver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span> <span class="o">=</span> <span class="n">obj_value_ia</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">original_problem</span><span class="o">.</span><span class="n">local_solve_fast</span><span class="p">(</span><span class="n">w_ia</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                       <span class="n">iter_index</span><span class="p">)</span></div>

<div class="viewcode-block" id="RefactoryColGen.find_solution"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.find_solution">[docs]</a>    <span class="k">def</span> <span class="nf">find_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iter_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Primal heuristics method</span>

<span class="sd">        :param iter_index: number of main iteration when the method is called</span>
<span class="sd">        :type: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">=======================================================&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Find solution - projection from ia solution - &#39;</span>
                    <span class="s1">&#39;local search&#39;</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">tilde_y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">obj_value_ia</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">master_problems</span><span class="o">.</span><span class="n">solve_ia</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lp_solver</span><span class="p">)</span>  <span class="c1"># solve the inner problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cg_relaxation</span> <span class="o">=</span> <span class="n">obj_value_ia</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">original_problem</span><span class="o">.</span><span class="n">local_solve</span><span class="p">(</span><span class="n">tilde_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="n">iter_index</span><span class="p">)</span></div>

<div class="viewcode-block" id="RefactoryColGen.print_z_values"><a class="viewcode-back" href="../../../sources/generated/decogo.solver.refactory_colgen.html#decogo.solver.refactory_colgen.RefactoryColGen.print_z_values">[docs]</a>    <span class="k">def</span> <span class="nf">print_z_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints sorted z-weights blockwise</span>

<span class="sd">        :param z: Weight vector</span>
<span class="sd">        :type z: BlockVector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">non_zero_z</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
            <span class="n">non_zero_z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">non_zero_z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
            <span class="n">non_zero_z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;z values&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Pairs (index z_k values), such that z_k &gt; 0, sorted by z_k values&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">block_model</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;block </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">non_zero_z</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Pavlo Muts, Ouyang Wu and Ivo Nowak.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>